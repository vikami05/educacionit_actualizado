<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Campus Virtual - Python</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='Campus/Cursos/Python/campus.css') }}">
</head>
<body>

<nav class="navbar navbar-dark bg-dark px-3">
    <span class="navbar-text text-white">Bienvenido al Campus Educaci√≥nIT</span>

    <div class="dropdown">
      <a class="d-flex align-items-center text-white text-decoration-none dropdown-toggle"
         href="#" id="dropdownUser" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="bi bi-person-circle user-icon fs-4"></i>
        <span class="ms-2">{{ usuario.nombre if usuario else 'Usuario' }}</span>
      </a>

      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownUser">
        <li>
          <a class="dropdown-item" href="{{ url_for('inicio_campus') }}">
            <i class="bi bi-house-door me-2"></i>Inicio
          </a>
        </li>
        <li>
          <a class="dropdown-item" href="{{ url_for('mis_cursos') }}">
            <i class="bi bi-journal-text me-2"></i>Mis cursos
          </a>
        </li>
        <li>
          <a class="dropdown-item" href="{{ url_for('logout') }}">
            <i class="bi bi-box-arrow-right me-2"></i>Salir
          </a>
        </li>
      </ul>
    </div>
  </nav>

<div class="campus-container">
  <aside class="sidebar">
    <h4>Python</h4>
    <ul class="list-group" id="lista-modulos"></ul>
  </aside>

  <main class="content d-flex flex-column justify-content-center align-items-center text-center">
    <div id="pantalla-inicial">
      <h2>Bienvenid@ al Curso de Python</h2>
      <p class="mt-3">
        En este curso aprender√°s Python desde lo m√°s b√°sico hasta conceptos avanzados.
        Contamos con <strong>5 m√≥dulos</strong> que incluyen:
      </p>
      <ul class="text-start mx-auto" style="max-width:500px;">
        <li>Introducci√≥n y conceptos b√°sicos</li>
        <li>Variables y tipos de datos</li>
        <li>Control de flujo</li>
        <li>Condicionales y listas</li>
        <li>Diccionarios y tuplas</li>
      </ul>
      <p class="mt-3">
        Ante cualquier duda, pod√©s escribir al correo de la profesora <strong>Mar√≠a Lopez</strong>: 
        <a href="mailto:maria.lopez@educacionit.com">maria.lopez@educacionit.com</a>
      </p>
      <button id="btn-comenzar" class="btn btn-primary mt-3">Comenzar</button>
    </div>

    <div id="contenido-curso" style="display:none; width:100%;">
      <h2 id="titulo-leccion"></h2>
      <div id="contenido-leccion"></div>
      <div class="d-flex justify-content-end">
        <button id="btn-siguiente" class="btn btn-primary mt-3" onclick="siguienteTema()" disabled>Siguiente</button>
      </div>
    </div>

    <!--Ac√° marca en rojo, pero, a√∫n asi funciona el script. Solamente no es compatible, porque no lo reconoce el Visual, pero si funciona-->
   <button id="btn-evaluacion"
        class="btn btn-warning mt-3"
        onclick="window.location.href='{{ url_for('curso_python_prueba') }}';"
        style="display:none;">
    Realizar Evaluaci√≥n Final
   </button>
  </main>
</div>

<script>
const curso = [
  {
    titulo: "M√≥dulo 1: Introducci√≥n",
    temas: [
      {
        titulo: "Instalaci√≥n de Python",
        contenido: `
          <div class="tema-contenido">
          <div class="video-container">
            <iframe src="https://www.youtube-nocookie.com/embed/2BMaxJQxQ6U" title="Video Instalaci√≥n de Python" allowfullscreen></iframe>
          </div>
          <div class="descripcion-container text-center" style="max-width: 800px; margin: 0 auto;">
            <h3>Proceso de Instalaci√≥n y Primeros Pasos</h3>
            <p>
              Instalar Python en tu computadora es un paso fundamental si deseas comenzar a programar o ejecutar scripts y aplicaciones que dependan de este lenguaje. Python es un lenguaje de programaci√≥n de alto nivel, muy popular por su simplicidad, legibilidad y versatilidad, utilizado tanto por principiantes como por profesionales en desarrollo web, an√°lisis de datos, inteligencia artificial, automatizaci√≥n y muchas otras √°reas. A continuaci√≥n, se detalla el proceso de instalaci√≥n de Python en los sistemas operativos m√°s comunes: Windows, macOS y Linux.
            </p>
            <p>
              Ante cualquier duda, puedes comunicarte con el profesor 
              <a href="mailto:maria.lopez@educacionit.com" style="text-decoration: none; color: #0d6efd; display: inline-flex; align-items: center; gap: 5px;">
                <i class="bi bi-envelope-fill"></i> maria.lopez@educacionit.com
              </a>
            </p>
          </div>
        </div>`
      },
      {
        titulo: "Operadores L√≥gicos y de Comparaci√≥n",
        contenido: `
        <div class="tema-contenido">
          <div class="video-container">
            <iframe src="https://www.youtube-nocookie.com/embed/TONhzLxD9WM" title="Video Operadores L√≥gicos y de Comparaci√≥n" allowfullscreen></iframe>
          </div>
          <div class="descripcion-container">
            <h3>¬øQu√© aprender√°s?</h3>
            <p>Los operadores l√≥gicos y de comparaci√≥n son herramientas fundamentales en Python que nos permiten tomar decisiones y controlar el flujo de nuestro c√≥digo. Se utilizan para comparar valores, combinar condiciones y determinar si ciertas afirmaciones son verdaderas o falsas, lo que resulta esencial para implementar estructuras de control como if, else y elif.</p>
          </div>
        </div>`
      }
    ]
  },
  {
    titulo: "M√≥dulo 2: Variables y Tipos",
    temas: [
      {
        titulo: "Variables",
        contenido: `
        <div class="tema-contenido">
          <div class="video-container">
            <iframe src="https://www.youtube-nocookie.com/embed/XqWEAM3MAYE" title="Video Variables" allowfullscreen></iframe>
          </div>
          <div class="descripcion-container">
            <h3>¬øQu√© aprender√°s?</h3>
            <p>En este tema aprender√°s a declarar y usar variables en Python, uno de los conceptos fundamentales de cualquier lenguaje de programaci√≥n. Las variables son espacios en la memoria donde podemos almacenar informaci√≥n, como n√∫meros, texto, valores booleanos o colecciones de datos, y manipularla a lo largo de nuestro programa.</p>
          </div>
        </div>`
      },
      {
        titulo: "Tipos de datos",
        contenido: `
        <div class="tema-contenido">
          <div class="video-container">
            <iframe src="https://www.youtube-nocookie.com/embed/lqowuoM4OJg" title="Video Tipos de Datos" allowfullscreen></iframe>
          </div>
          <div class="descripcion-container">
            <h3>¬øQu√© aprender√°s?</h3>
            <p>En Python, los tipos de datos son fundamentales para almacenar y manipular informaci√≥n de manera eficiente. Cada variable tiene un tipo que determina qu√© valores puede almacenar y qu√© operaciones se le pueden aplicar. Conocer los tipos b√°sicos te permitir√° escribir programas correctos y m√°s f√°ciles de entender.</p>
          </div>
        </div>`
      }
    ]
  },
  {
    titulo: "M√≥dulo 3: Condicionales y Listas",
    temas: [
      {
        titulo: "Condicionales",
        contenido: `
        <div class="tema-contenido">
          <div class="video-container">
            <iframe src="https://www.youtube-nocookie.com/embed/lLLr34ZDEJ4" title="Video Condicionales" allowfullscreen></iframe>
          </div>
          <div class="descripcion-container">
            <h3>¬øQu√© aprender√°s?</h3>
            <p>Los condicionales en Python son una de las herramientas fundamentales para tomar decisiones dentro de un programa. Permiten que tu c√≥digo reaccione de manera diferente seg√∫n ciertas condiciones, haciendo posible implementar l√≥gica din√°mica y comportamientos distintos seg√∫n los valores de las variables o las entradas del usuario.</p>
          </div>
        </div>`
      },
      {
        titulo: "Listas",
        contenido: `
        <div class="tema-contenido">
          <div class="video-container">
            <iframe src="https://www.youtube-nocookie.com/embed/lLLr34ZDEJ4" title="Video Listas" allowfullscreen></iframe>
          </div>
          <div class="descripcion-container">
            <h3>¬øQu√© aprender√°s?</h3>
            <p>En Python, las listas son uno de los tipos de datos m√°s vers√°tiles y utilizados. Permiten almacenar colecciones de elementos ordenados, que pueden ser de cualquier tipo de dato: n√∫meros, cadenas de texto, valores booleanos, e incluso otras listas. Aprender a trabajar con listas es fundamental para gestionar datos de manera eficiente y construir programas din√°micos y flexibles.</p>
          </div>
        </div>`
      }
    ]
  },
  {
    titulo: "M√≥dulo 4: Diccionarios y Tuplas",
    temas: [
      {
        titulo: "Diccionarios",
        contenido: `
        <div class="tema-contenido">
          <div class="video-container">
            <iframe src="https://www.youtube-nocookie.com/embed/IvxqTo6QBMU" title="Video Diccionarios" allowfullscreen></iframe>
          </div>
          <div class="descripcion-container">
            <h3>¬øQu√© aprender√°s?</h3>
            <p>Los diccionarios son una estructura de datos fundamental en Python que permiten almacenar informaci√≥n en pares clave-valor, lo que facilita el acceso r√°pido y la organizaci√≥n eficiente de datos. A diferencia de las listas o tuplas, los diccionarios no est√°n ordenados por posici√≥n, sino por claves √∫nicas.</p>
          </div>
        </div>`
      },
      {
        titulo: "Tuplas",
        contenido: `
        <div class="tema-contenido">
          <div class="video-container">
            <iframe src="https://www.youtube-nocookie.com/embed/jZjntRsHeRg" title="Video Tuplas" allowfullscreen></iframe>
          </div>
          <div class="descripcion-container">
            <h3>¬øQu√© aprender√°s?</h3>
            <p>Las tuplas son una estructura de datos fundamental en Python que permiten almacenar colecciones de elementos ordenados, similares a las listas, pero con una diferencia clave: son inmutables, lo que las hace ideales para representar datos que no deben cambiar a lo largo del programa.</p>
          </div>
        </div>`
      }
    ]
  }
];

// ============================================
// VARIABLES GLOBALES
// ============================================
let moduloActual = 0;
let temaActual = 0;
const ID_CURSO = 5; // ID del curso 

const listaModulos = document.getElementById('lista-modulos');
const tituloLeccion = document.getElementById('titulo-leccion');
const contenidoLeccion = document.getElementById('contenido-leccion');
const btnSiguiente = document.getElementById('btn-siguiente');
const btnComenzar = document.getElementById('btn-comenzar');
const btnEvaluacion = document.getElementById('btn-evaluacion');

// ============================================
// FUNCIONES PARA INTERACTUAR CON LA API
// ============================================

// Guardar progreso en la base de datos
async function guardarProgreso() {
  const progreso = {
    modulo_actual: moduloActual,
    tema_actual: temaActual,
    datos_progreso: curso.map(mod => ({
      habilitado: mod.habilitado,
      temas: mod.temas.map(t => ({
        hecho: t.hecho,
        habilitado: t.habilitado
      }))
    }))
    // ‚úÖ NO enviar curso_completado aqu√≠
  };

  try {
    const response = await fetch(`/api/progreso/${ID_CURSO}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(progreso)
    });

    const data = await response.json();
    if (!response.ok) {
      console.error('Error al guardar progreso:', data.error);
    } else {
      console.log('‚úÖ Progreso guardado correctamente');
    }
  } catch (error) {
    console.error('Error de conexi√≥n al guardar progreso:', error);
  }
}

// Cargar progreso desde la base de datos
async function cargarProgresoBaseDatos() {
  try {
    const response = await fetch(`/api/progreso/${ID_CURSO}`);
    const data = await response.json();

    if (!response.ok) {
      console.error('Error al cargar progreso:', data.error);
      return false;
    }

    if (!data.existe) {
      return false; // No hay progreso guardado
    }

    // Restaurar estado de m√≥dulos y temas
    if (data.datos_progreso) {
      data.datos_progreso.forEach((mod, i) => {
        if (curso[i]) {
          curso[i].habilitado = mod.habilitado;
          mod.temas.forEach((t, j) => {
            if (curso[i].temas[j]) {
              curso[i].temas[j].hecho = t.hecho;
              curso[i].temas[j].habilitado = t.habilitado;
            }
          });
        }
      });
    }

    moduloActual = data.modulo_actual;
    temaActual = data.tema_actual;

    return true;
  } catch (error) {
    console.error('Error de conexi√≥n al cargar progreso:', error);
    return false;
  }
}

// Marcar curso como completado
async function aprobarCurso() {
  try {
    const response = await fetch(`/api/progreso/${ID_CURSO}/completar`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });

    const data = await response.json();
    if (response.ok) {
      console.log('‚úÖ Curso completado en la base de datos');
      mostrarCursoCompletadoGlobal();
    } else {
      console.error('Error al completar curso:', data.error);
    }
  } catch (error) {
    console.error('Error de conexi√≥n al aprobar curso:', error);
  }
}

// Verificar si el curso ya fue completado
async function verificarCursoCompletado() {
  try {
    const response = await fetch(`/api/progreso/${ID_CURSO}`);
    const data = await response.json();

    if (response.ok && data.existe && data.curso_completado) {
      return true;
    }
    return false;
  } catch (error) {
    console.error('Error al verificar curso completado:', error);
    return false;
  }
}

// ============================================
// INICIALIZACI√ìN DE M√ìDULOS Y TEMAS
// ============================================
curso.forEach(m => {
  m.habilitado = false;
  m.temas.forEach(t => {
    t.hecho = false;
    t.habilitado = false;
  });
});

// ============================================
// CARGAR M√ìDULOS EN SIDEBAR
// ============================================
function cargarModulos() {
  listaModulos.innerHTML = "";
  curso.forEach((modulo, i) => {
    const li = document.createElement('li');
    li.classList.add('list-group-item');
    if (!modulo.habilitado) li.classList.add('deshabilitado');

    const todosHechos = modulo.temas.every(t => t.hecho);
    const iconoCheck = todosHechos ? `<i class="bi bi-check2 modulo-completo"></i>` : "";

    li.innerHTML = `
      <a class="modulo-link" data-bs-toggle="collapse" href="#modulo${i}" role="button">
        ${modulo.titulo} ${iconoCheck} <i class="bi bi-chevron-down"></i>
      </a>
      <ul class="list-group collapse" id="modulo${i}"></ul>
    `;
    listaModulos.appendChild(li);

    const ulTemas = li.querySelector('ul');
    modulo.temas.forEach((tema, j) => {
      const temaLi = document.createElement('li');
      temaLi.classList.add('list-group-item', 'tema-item');
      temaLi.textContent = tema.titulo;

      if (tema.habilitado) {
        temaLi.style.cursor = 'pointer';
        temaLi.style.opacity = '1';
        temaLi.onclick = () => mostrarTema(i, j);
      } else {
        temaLi.style.cursor = 'not-allowed';
        temaLi.style.opacity = '0.5';
      }

      ulTemas.appendChild(temaLi);
    });
  });
}

// ============================================
// MOSTRAR TEMA
// ============================================
async function mostrarTema(m, t) {
  if (!curso[m].habilitado || !curso[m].temas[t].habilitado) {
    alert("Debes completar los temas anteriores primero.");
    return;
  }

  console.log(`üéØ Mostrando tema: M√≥dulo ${m}, Tema ${t}`);

  moduloActual = m;
  temaActual = t;
  const tema = curso[m].temas[t];
  tituloLeccion.textContent = tema.titulo;
  contenidoLeccion.innerHTML = tema.contenido;

  let botonesHTML = `<button class="btn btn-success" id="btn-hecho">Marcar como hecho</button>`;
  if (m === 1 && t === 1) {
    botonesHTML += `<button class="btn btn-primary ms-2" id="btn-pdf" onclick="window.open('{{ url_for('static', filename='Material/EjerciciosPython.pdf') }}', '_blank')">Ver PDF de pr√°ctica</button>`;
  }

  const contenedorBotones = document.createElement('div');
  contenedorBotones.id = 'botones-leccion';
  contenedorBotones.className = 'd-flex gap-2 mt-3 justify-content-end';
  contenedorBotones.innerHTML = botonesHTML;
  contenidoLeccion.appendChild(contenedorBotones);

  btnSiguiente.disabled = true;
  btnSiguiente.style.display = (m === curso.length - 1 && t === curso[m].temas.length - 1)
    ? 'none' : 'inline-block';

  // ‚úÖ Verificar si el tema ya est√° marcado como hecho
  const btnHecho = document.getElementById('btn-hecho');
  if (tema.hecho) {
    btnHecho.disabled = true;
    btnHecho.textContent = '‚úì Completado';
    btnHecho.classList.remove('btn-success');
    btnHecho.classList.add('btn-secondary');
    btnSiguiente.disabled = false;
  } else {
    btnHecho.onclick = () => marcarComoHecho(m, t);
  }

  // ‚úÖ CR√çTICO: Verificar estado del bot√≥n de evaluaci√≥n
  await verificarMostrarBotonEvaluacion();
  
  await guardarProgreso();
}

// ============================================
// MARCAR TEMA COMO HECHO
// ============================================
async function marcarComoHecho(m, t) {
  curso[m].temas[t].hecho = true;
  
  // Deshabilitar el bot√≥n inmediatamente
  const btnHecho = document.getElementById('btn-hecho');
  if (btnHecho) {
    btnHecho.disabled = true;
    btnHecho.textContent = '‚úì Completado';
    btnHecho.classList.remove('btn-success');
    btnHecho.classList.add('btn-secondary');
  }
  
  btnSiguiente.disabled = false;

  if (t + 1 < curso[m].temas.length) {
    curso[m].temas[t + 1].habilitado = true;
  } else if (m + 1 < curso.length) {
    curso[m + 1].habilitado = true;
    curso[m + 1].temas[0].habilitado = true;
  }

  await guardarProgreso();
  cargarModulos();
  
  // ‚úÖ Verificar despu√©s de guardar
  await verificarMostrarBotonEvaluacion();
}

// ============================================
// VERIFICAR SI MOSTRAR BOT√ìN DE EVALUACI√ìN
// ============================================
async function verificarMostrarBotonEvaluacion() {
  console.log('üîç Verificando estado del bot√≥n de evaluaci√≥n...');
  
  // ‚úÖ PASO 1: SIEMPRE verificar primero si el curso est√° completado en la BD
  const completado = await verificarCursoCompletado();
  
  console.log('üìä Estado del curso:', completado ? '‚úÖ Completado' : '‚è≥ En progreso');
  
  // Si ya est√° completado, NUNCA mostrar el bot√≥n
  if (completado) {
    btnEvaluacion.style.display = 'none';
    console.log('üîí Curso completado - Bot√≥n de evaluaci√≥n OCULTO permanentemente');
    return;
  }
  
  // ‚úÖ PASO 2: Verificar si estamos en el √∫ltimo tema
  const ultimoModulo = curso.length - 1;
  const ultimoTema = curso[ultimoModulo].temas.length - 1;
  
  console.log(`üìç Ubicaci√≥n actual: M√≥dulo ${moduloActual}/${ultimoModulo}, Tema ${temaActual}/${ultimoTema}`);
  
  if (moduloActual !== ultimoModulo || temaActual !== ultimoTema) {
    // No estamos en el √∫ltimo tema
    btnEvaluacion.style.display = 'none';
    console.log('üìç No est√°s en el √∫ltimo tema - Bot√≥n oculto');
    return;
  }
  
  // ‚úÖ PASO 3: Verificar si todos los temas est√°n marcados como hechos
  const todosTemasMarcados = curso.every(mod => 
    mod.temas.every(t => t.hecho)
  );
  
  console.log('üìù Todos los temas completados:', todosTemasMarcados ? 'S√≠ ‚úÖ' : 'No ‚ùå');
  
  if (todosTemasMarcados) {
    btnEvaluacion.style.display = 'block';
    console.log('‚úÖ Todos los temas completados - Bot√≥n VISIBLE');
  } else {
    btnEvaluacion.style.display = 'none';
    console.log('‚è≥ Faltan temas por completar - Bot√≥n oculto');
  }
}

// ============================================
// MOSTRAR CURSO COMPLETADO
// ============================================
function mostrarCursoCompletadoGlobal() {
  btnEvaluacion.style.display = 'none';

  curso.forEach(mod => {
    mod.habilitado = true;
    mod.temas.forEach(t => {
      t.hecho = true;
      t.habilitado = true;
    });
  });

  cargarModulos();

  contenidoLeccion.innerHTML = "";
  const mensaje = document.createElement('div');
  mensaje.className = 'alert alert-success mt-4 text-center fw-bold';
  mensaje.textContent = 'üéâ ¬°Felicidades! Has completado el curso de Python exitosamente.';
  contenidoLeccion.appendChild(mensaje);
}

// ============================================
// BOT√ìN SIGUIENTE
// ============================================
function siguienteTema() {
  if (temaActual < curso[moduloActual].temas.length - 1) {
    mostrarTema(moduloActual, temaActual + 1);
  } else if (moduloActual < curso.length - 1) {
    mostrarTema(moduloActual + 1, 0);
  } else {
    btnSiguiente.disabled = true;
  }
  guardarProgreso();
}

// ============================================
// BOT√ìN COMENZAR
// ============================================
btnComenzar.onclick = () => {
  console.log('üöÄ Iniciando curso...');
  document.getElementById('pantalla-inicial').style.display = 'none';
  document.getElementById('contenido-curso').style.display = 'block';
  curso[0].habilitado = true;
  curso[0].temas[0].habilitado = true;
  cargarModulos();
  mostrarTema(0, 0);
};

// ============================================
// AL CARGAR LA P√ÅGINA
// ============================================
document.addEventListener("DOMContentLoaded", async () => {
  console.log('üöÄ Iniciando Campus Virtual...');
  
  // ‚úÖ PASO 1: Verificar si el curso ya est√° completado
  const completado = await verificarCursoCompletado();
  
  console.log('üìä Estado inicial del curso:', completado ? '‚úÖ COMPLETADO' : '‚è≥ En progreso');
  
  if (completado) {
    console.log('üéì Mostrando pantalla de curso completado...');
    document.getElementById('pantalla-inicial').style.display = 'none';
    document.getElementById('contenido-curso').style.display = 'block';
    await cargarProgresoBaseDatos();
    cargarModulos();
    mostrarCursoCompletadoGlobal();
    
    // ‚úÖ ASEGURAR que el bot√≥n est√© oculto
    btnEvaluacion.style.display = 'none';
    console.log('üîí Bot√≥n de evaluaci√≥n OCULTO (curso completado)');
  } else {
    // ‚úÖ PASO 2: Cargar progreso guardado
    const tieneProgreso = await cargarProgresoBaseDatos();
    
    if (tieneProgreso) {
      console.log('üìÇ Progreso encontrado, restaurando estado...');
      document.getElementById('pantalla-inicial').style.display = 'none';
      document.getElementById('contenido-curso').style.display = 'block';
      cargarModulos();
      mostrarTema(moduloActual, temaActual);
      
      // ‚úÖ Verificar bot√≥n de evaluaci√≥n despu√©s de cargar progreso
      await verificarMostrarBotonEvaluacion();
    } else {
      console.log('üìù Sin progreso previo, mostrando pantalla inicial');
      // Si no hay progreso, mostrar pantalla inicial
      cargarModulos();
      btnEvaluacion.style.display = 'none';
    }
  }
  
  console.log('‚úÖ Campus Virtual cargado correctamente');
});
 

</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
